<div class="flex min-h-screen overflow-hidden" [@fadeInOut]>
  <p-toast position="top-center"></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <div *ngIf="isLoading" class="loading-overlay">
    <p-progressSpinner strokeWidth="4" fill="transparent" animationDuration=".5s"></p-progressSpinner>
  </div>

  <div class="dashboard-container pt-6 p-2 pl-0 flex-grow-1 overflow-auto">
    <div class="grid align-items-stretch m-0 g-2">

      <div class="col-12 lg:col-10 p-2 table-column">
        <p-card styleClass="shadow-2 border-round-xl m-0 h-full">
          <div class="table-header mb-3">
            <div class="search-wrapper">
              <i class="pi pi-search search-icon"></i>
              <input
                pInputText
                type="text"
                [(ngModel)]="searchValue"
                (input)="onGlobalFilter($event)"
                placeholder="Search customers..."
                class="search-input" />
              <i
                *ngIf="searchValue"
                class="pi pi-times clear-icon"
                (click)="clearSearch()">
              </i>
            </div>
          </div>

          <p-table
            *ngIf="!isLoading"
            #dt
            [value]="customers"
            [rows]="18"
            [paginator]="true"
            [globalFilterFields]="['info', 'salesOrders', 'invoices', 'paymentHistory', 'communication', 'category', 'feedback', 'notes', 'supportRequest']"
            styleClass="p-datatable-sm p-datatable-striped"
            [rowHover]="true"
            [(selection)]="selectedCustomer"
            selectionMode="single"
            dataKey="id">
            <ng-template pTemplate="header">
              <tr>
                <th class="text-xs" pSortableColumn="id">ID <p-sortIcon field="id"></p-sortIcon></th>
                <th class="text-xs" pSortableColumn="info">INFO <p-sortIcon field="info"></p-sortIcon></th>
                <th class="text-xs" pSortableColumn="salesOrders">SALES ORDER <p-sortIcon field="salesOrders"></p-sortIcon></th>
                <th class="text-xs" pSortableColumn="invoices">INVOICE <p-sortIcon field="invoices"></p-sortIcon></th>
                <th class="text-xs" pSortableColumn="paymentHistory">PAYMENT HISTORY <p-sortIcon field="paymentHistory"></p-sortIcon></th>
                <th class="text-xs" pSortableColumn="communication">COMMUNICATION <p-sortIcon field="communication"></p-sortIcon></th>
                <th class="text-xs" pSortableColumn="category">CATEGORY <p-sortIcon field="category"></p-sortIcon></th>
                <th class="text-xs" pSortableColumn="feedback">FEEDBACK <p-sortIcon field="feedback"></p-sortIcon></th>
                <th class="text-xs" pSortableColumn="notes">NOTES <p-sortIcon field="notes"></p-sortIcon></th>
                <th class="text-xs" pSortableColumn="supportRequest">SUPPORT <p-sortIcon field="supportRequest"></p-sortIcon></th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-customer>
              <tr class="text-xs" [pSelectableRow]="customer">
                <td>{{customer.id}}</td>
                <td class="font-bold text-blue-600">{{customer.info}}</td>
                <td>{{customer.salesOrders}}</td>
                <td><p-tag [value]="customer.invoices" [severity]="customer.invoices === 'yes' ? 'success' : 'danger'"></p-tag></td>
                <td><p-tag [value]="customer.paymentHistory" [severity]="customer.paymentHistory === 'yes' ? 'info' : 'warn'"></p-tag></td>
                <td>{{customer.communication}}</td>
                <td>{{customer.category}}</td>
                <td>{{customer.feedback}}</td>
                <td>{{customer.notes}}</td>
                <td>{{customer.supportRequest}}</td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="10">
                  <div class="empty-state">
                    <div class="empty-state-icon">
                      <i class="pi pi-users"></i>
                    </div>
                    <h3 class="empty-state-title">{{ searchValue ? 'No customers found' : 'No customers yet' }}</h3>
                    <p class="empty-state-message">
                      {{ searchValue ? 'Try adjusting your search criteria.' : 'Start by adding your first customer to the system.' }}
                    </p>
                    <p-button
                      *ngIf="!searchValue"
                      label="Add First Customer"
                      icon="pi pi-plus"
                      severity="success"
                      (onClick)="showDialog()">
                    </p-button>
                    <p-button
                      *ngIf="searchValue"
                      label="Clear Search"
                      icon="pi pi-times"
                      severity="secondary"
                      (onClick)="clearSearch()">
                    </p-button>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </p-card>
      </div>

      <div class="col-12 lg:col-2 p-2 operations-panel-desktop">
        <p-card styleClass="shadow-2 border-round-xl m-0 h-full operations-card">
          <div class="flex justify-content-center pt-4 mb-2">
            <img [src]="getLogoPath()" alt="Logo" class="main-logo">
          </div>

          <div class="action-buttons-wrapper">
            <div class="flex flex-column gap-3 action-buttons">
              <p-button
                label="SHOW"
                icon="pi pi-eye"
                styleClass="w-full"
                (onClick)="onShowCustomer()">
              </p-button>

              <p-button
                label="INSERT"
                icon="pi pi-plus"
                severity="success"
                styleClass="w-full"
                (onClick)="showDialog()">
              </p-button>

              <p-button
                label="UPDATE"
                icon="pi pi-refresh"
                severity="warn"
                styleClass="w-full"
                (onClick)="showUpdateDialog()">
              </p-button>

              <p-button
                label="DELETE"
                icon="pi pi-trash"
                severity="danger"
                styleClass="w-full"
                (onClick)="deleteCustomer()">
              </p-button>
            </div>
          </div>

          <div class="export-section">
            <div class="text-xs font-bold text-400 mb-3 uppercase text-center tracking-wider">Export & System</div>
            <div class="export-grid">
              <p-button icon="pi pi-file-excel" [text]="true" pTooltip="XLSX" (onClick)="exportToExcel()"></p-button>
              <p-button icon="pi pi-file-edit" [text]="true" pTooltip="CSV" (onClick)="exportToCSV()"></p-button>
              <p-button icon="pi pi-file-pdf" [text]="true" pTooltip="PDF" (onClick)="exportToPDF()"></p-button>
              <p-button icon="pi pi-code" [text]="true" pTooltip="HTML" (onClick)="exportToHTML()"></p-button>
              <p-button icon="pi pi-database" [text]="true" pTooltip="JSON" (onClick)="exportToJSON()"></p-button>
              <p-button icon="pi pi-power-off" [text]="true" pTooltip="Exit" class="logout-btn" (onClick)="onLogout()"></p-button>
            </div>
          </div>
        </p-card>
      </div>
    </div>
  </div>

  <p-dialog [header]="getDialogHeader()" [(visible)]="displayDialog" [modal]="true" [style]="{width: '600px'}" styleClass="custom-dialog">
    <ng-template pTemplate="content">
      <div class="dialog-form-container">
        <div class="field-row" [class.field-invalid]="submitted && !newCustomer.info?.trim()">
          <i class="pi pi-info-circle field-icon"></i>
          <label class="field-label">INFO *</label>
          <div class="field-input">
            <input type="text" pInputText [(ngModel)]="newCustomer.info" placeholder="Customer name or ID" class="w-full" />
            <small *ngIf="submitted && !newCustomer.info?.trim()" class="field-error">
              <i class="pi pi-exclamation-circle"></i> Customer info is required
            </small>
          </div>
        </div>
        <div class="field-row" [class.field-invalid]="submitted && !newCustomer.salesOrders">
          <i class="pi pi-shopping-cart field-icon"></i>
          <label class="field-label">SALES ORDERS *</label>
          <div class="field-input">
            <p-select [(ngModel)]="newCustomer.salesOrders" [options]="orderOptions" optionLabel="label" optionValue="value" placeholder="Select order type" styleClass="w-full"></p-select>
            <small *ngIf="submitted && !newCustomer.salesOrders" class="field-error">
              <i class="pi pi-exclamation-circle"></i> Please select an order type
            </small>
          </div>
        </div>
        <div class="field-row">
          <i class="pi pi-file field-icon"></i>
          <label class="field-label">INVOICES</label>
          <div class="field-input">
            <p-select [(ngModel)]="newCustomer.invoices" [options]="yesNoOptions" optionLabel="label" optionValue="value" placeholder="Select" styleClass="w-full"></p-select>
          </div>
        </div>
        <div class="field-row">
          <i class="pi pi-credit-card field-icon"></i>
          <label class="field-label">PAYMENT H.</label>
          <div class="field-input">
            <p-select [(ngModel)]="newCustomer.paymentHistory" [options]="yesNoOptions" optionLabel="label" optionValue="value" placeholder="Select" styleClass="w-full"></p-select>
          </div>
        </div>
        <div class="field-row" [class.field-invalid]="submitted && !isEmailValid()">
          <i class="pi pi-envelope field-icon"></i>
          <label class="field-label">EMAIL *</label>
          <div class="field-input">
            <input type="email" pInputText [(ngModel)]="newCustomer.communication" placeholder="customer@example.com" class="w-full" />
            <small *ngIf="submitted && !newCustomer.communication?.trim()" class="field-error">
              <i class="pi pi-exclamation-circle"></i> Email is required
            </small>
            <small *ngIf="submitted && newCustomer.communication?.trim() && !isValidEmailFormat()" class="field-error">
              <i class="pi pi-exclamation-circle"></i> Please enter a valid email address
            </small>
          </div>
        </div>
        <div class="field-row" [class.field-invalid]="submitted && !newCustomer.category">
          <i class="pi pi-tag field-icon"></i>
          <label class="field-label">CATEGORY *</label>
          <div class="field-input">
            <p-select [(ngModel)]="newCustomer.category" [options]="categoryOptions" optionLabel="label" optionValue="value" placeholder="Select category" styleClass="w-full"></p-select>
            <small *ngIf="submitted && !newCustomer.category" class="field-error">
              <i class="pi pi-exclamation-circle"></i> Please select a category
            </small>
          </div>
        </div>
        <div class="field-row has-textarea">
          <i class="pi pi-comment field-icon"></i>
          <label class="field-label">FEEDBACK</label>
          <div class="field-input">
            <textarea pInputTextarea [(ngModel)]="newCustomer.feedback" placeholder="Customer feedback" rows="2" class="w-full"></textarea>
          </div>
        </div>
        <div class="field-row has-textarea">
          <i class="pi pi-pencil field-icon"></i>
          <label class="field-label">NOTES</label>
          <div class="field-input">
            <textarea pInputTextarea [(ngModel)]="newCustomer.notes" placeholder="Additional notes" rows="2" class="w-full"></textarea>
          </div>
        </div>
        <div class="field-row">
          <i class="pi pi-question-circle field-icon"></i>
          <label class="field-label">SUPPORT</label>
          <div class="field-input">
            <input type="text" pInputText [(ngModel)]="newCustomer.supportRequest" placeholder="e.g. None, 1 pending" class="w-full" />
          </div>
        </div>
        <div class="text-xs text-500 mt-2">
          * Required fields
        </div>
      </div>
    </ng-template>
    <ng-template pTemplate="footer">
      <div class="flex justify-content-end gap-2">
        <p-button label="Cancel" icon="pi pi-times" [text]="true" (onClick)="closeDialog()"></p-button>
        <p-button [label]="getSaveButtonLabel()" icon="pi pi-check" [severity]="isEditMode ? 'warn' : 'success'" (onClick)="saveCustomer()"></p-button>
      </div>
    </ng-template>
  </p-dialog>
</div>
