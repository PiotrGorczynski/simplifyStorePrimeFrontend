<p-toast position="top-center"></p-toast>
<div class="flex min-h-screen overflow-hidden">

  <div class="analytics-container pt-6 p-4 flex-grow-1 overflow-auto" [@fadeInOut]>

    <div class="flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
      <h1 class="text-4xl font-bold m-0">
        <i class="pi pi-chart-bar mr-3"></i>
        Analytics Dashboard
      </h1>
      <div class="export-bar flex gap-2">
        <p-button
          label="PDF"
          icon="pi pi-file-pdf"
          (onClick)="exportToPDF()"
          severity="danger"
          [disabled]="!analyticsData || isLoading">
        </p-button>
        <p-button
          label="JSON"
          icon="pi pi-database"
          (onClick)="exportToJSON()"
          severity="info"
          [disabled]="!analyticsData || isLoading">
        </p-button>
        <p-button
          label="Refresh"
          icon="pi pi-refresh"
          (onClick)="refreshData()"
          [loading]="isLoading"
          severity="success">
        </p-button>
      </div>
    </div>

    <div *ngIf="isLoading" class="loading-state">
      <p-progressSpinner
        styleClass="custom-spinner"
        strokeWidth="4"
        [style]="{ width: '80px', height: '80px' }">
      </p-progressSpinner>
      <h3 class="mt-4 text-2xl font-semibold">Loading Analytics...</h3>
      <p class="text-600">Please wait while we process your data</p>
    </div>

    <div *ngIf="errorMessage && !isLoading" class="error-state">
      <i class="pi pi-exclamation-triangle error-icon"></i>
      <h3 class="text-2xl font-bold mb-2">Oops! Something went wrong</h3>
      <p class="text-600 mb-4">{{errorMessage}}</p>
      <p-button
        label="Try Again"
        icon="pi pi-refresh"
        (onClick)="refreshData()"
        severity="danger">
      </p-button>
    </div>

    <div *ngIf="!analyticsData && !isLoading && !errorMessage" class="empty-state">
      <i class="pi pi-inbox empty-icon"></i>
      <h3 class="text-2xl font-bold mb-2">No Data Available</h3>
      <p class="text-600 mb-4">There are no transactions to display analytics for.</p>
      <p-button
        label="Refresh"
        icon="pi pi-refresh"
        (onClick)="refreshData()">
      </p-button>
    </div>

    <div *ngIf="analyticsData && !isLoading && !errorMessage">

      <div class="grid mb-4">
        <div class="col-12 md:col-6 lg:col-3">
          <p-card class="stats-card sales-card"
                  pTooltip="Total revenue from all transactions including returns"
                  tooltipPosition="top">
            <div class="flex justify-content-between align-items-center">
              <div>
                <div class="stat-label">
                  Total Sales
                  <i class="pi pi-info-circle ml-2 info-icon"
                     pTooltip="Sum of all transaction totals"
                     tooltipPosition="right">
                  </i>
                </div>
                <div class="stat-value">${{analyticsData.totalSales.toFixed(2)}}</div>
                <div class="stat-subtext">
                  <i class="pi pi-shopping-cart mr-1"></i>
                  {{analyticsData.recentTransactions}} transactions
                </div>
              </div>
              <i class="pi pi-dollar stat-icon"></i>
            </div>
          </p-card>
        </div>

        <div class="col-12 md:col-6 lg:col-3">
          <p-card class="stats-card customers-card"
                  pTooltip="Total number of registered customers"
                  tooltipPosition="top">
            <div class="flex justify-content-between align-items-center">
              <div>
                <div class="stat-label">
                  Total Customers
                  <i class="pi pi-info-circle ml-2 info-icon"
                     pTooltip="Active customer accounts"
                     tooltipPosition="right">
                  </i>
                </div>
                <div class="stat-value">{{analyticsData.totalCustomers}}</div>
                <div class="stat-subtext">
                  <i class="pi pi-users mr-1"></i>
                  Active accounts
                </div>
              </div>
              <i class="pi pi-users stat-icon"></i>
            </div>
          </p-card>
        </div>

        <div class="col-12 md:col-6 lg:col-3">
          <p-card class="stats-card products-card"
                  pTooltip="Total products in inventory"
                  tooltipPosition="top">
            <div class="flex justify-content-between align-items-center">
              <div>
                <div class="stat-label">
                  Total Products
                  <i class="pi pi-info-circle ml-2 info-icon"
                     pTooltip="Items available for sale"
                     tooltipPosition="right">
                  </i>
                </div>
                <div class="stat-value">{{analyticsData.totalProducts}}</div>
                <div class="stat-subtext">
                  <i class="pi pi-box mr-1"></i>
                  In catalog
                </div>
              </div>
              <i class="pi pi-box stat-icon"></i>
            </div>
          </p-card>
        </div>

        <div class="col-12 md:col-6 lg:col-3">
          <p-card class="stats-card deliveries-card"
                  pTooltip="Total deliveries processed"
                  tooltipPosition="top">
            <div class="flex justify-content-between align-items-center">
              <div>
                <div class="stat-label">
                  Total Deliveries
                  <i class="pi pi-info-circle ml-2 info-icon"
                     pTooltip="Completed and pending deliveries"
                     tooltipPosition="right">
                  </i>
                </div>
                <div class="stat-value">{{analyticsData.totalDeliveries}}</div>
                <div class="stat-subtext">
                  <i class="pi pi-truck mr-1"></i>
                  Shipments
                </div>
              </div>
              <i class="pi pi-truck stat-icon"></i>
            </div>
          </p-card>
        </div>
      </div>

      <div class="grid mb-4">
        <div class="col-12 lg:col-6">
          <p-card class="chart-card">
            <ng-template pTemplate="header">
              <div class="chart-header">
                <span class="chart-title">Payment Methods</span>
                <i class="pi pi-info-circle"
                   pTooltip="Distribution of payment methods used by customers"
                   tooltipPosition="left">
                </i>
              </div>
            </ng-template>
            <div class="chart-container">
              <canvas #paymentMethodsChart></canvas>
            </div>
          </p-card>
        </div>

        <div class="col-12 lg:col-6">
          <p-card class="chart-card">
            <ng-template pTemplate="header">
              <div class="chart-header">
                <span class="chart-title">Transaction Status</span>
                <i class="pi pi-info-circle"
                   pTooltip="Current status breakdown of all transactions"
                   tooltipPosition="left">
                </i>
              </div>
            </ng-template>
            <div class="chart-container">
              <canvas #statusChart></canvas>
            </div>
          </p-card>
        </div>
      </div>

      <div class="grid mb-4">
        <div class="col-12 lg:col-8">
          <p-card class="chart-card">
            <ng-template pTemplate="header">
              <div class="chart-header">
                <span class="chart-title">Transaction Trends</span>
                <i class="pi pi-info-circle"
                   pTooltip="Daily transaction count and revenue for the last 7 days"
                   tooltipPosition="left">
                </i>
              </div>
            </ng-template>
            <div class="chart-container-large">
              <canvas #transactionsByDateChart></canvas>
            </div>
          </p-card>
        </div>

        <div class="col-12 lg:col-4">
          <p-card class="chart-card">
            <ng-template pTemplate="header">
              <div class="chart-header">
                <span class="chart-title">Top Products</span>
                <i class="pi pi-info-circle"
                   pTooltip="Best selling products by total revenue"
                   tooltipPosition="left">
                </i>
              </div>
            </ng-template>
            <div class="chart-container">
              <canvas #topProductsChart></canvas>
            </div>
          </p-card>
        </div>
      </div>

    </div>
  </div>
</div>
